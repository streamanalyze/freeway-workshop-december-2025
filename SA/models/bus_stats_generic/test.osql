create function bus_test_stream() -> stream of vector
/* Function used to generate the data in test_stream() */
  as select merge([s,t])
       from stream s, stream t
      where s = (select stream of [now(), "s", hb]   // stream "s"
                   from real hb
                  where hb in heartbeat(0.1))
        and t = (select stream of [now(), "t", hb]   // stream "t"
                   from real hb
                  where hb in heartbeat(0.5));


create function test_stream() -> stream of vector
 as vstream([[|2025-11-26T10:10:57.052Z|,'s',0],
            [|2025-11-26T10:10:57.052Z|,'t',0],
            [|2025-11-26T10:10:57.165Z|,'s',0.1],
            [|2025-11-26T10:10:57.255Z|,'s',0.2],
            [|2025-11-26T10:10:57.361Z|,'s',0.3],
            [|2025-11-26T10:10:57.452Z|,'s',0.4],
            [|2025-11-26T10:10:57.558Z|,'t',0.5],
            [|2025-11-26T10:10:57.558Z|,'s',0.5],
            [|2025-11-26T10:10:57.664Z|,'s',0.6],
            [|2025-11-26T10:10:57.755Z|,'s',0.7],
            [|2025-11-26T10:10:57.860Z|,'s',0.8],
            [|2025-11-26T10:10:57.965Z|,'s',0.9],
            [|2025-11-26T10:10:58.055Z|,'t',1],
            [|2025-11-26T10:10:58.056Z|,'s',1],
            [|2025-11-26T10:10:58.160Z|,'s',1.1],
            [|2025-11-26T10:10:58.265Z|,'s',1.2],
            [|2025-11-26T10:10:58.355Z|,'s',1.3],
            [|2025-11-26T10:10:58.461Z|,'s',1.4],
            [|2025-11-26T10:10:58.551Z|,'s',1.5],
            [|2025-11-26T10:10:58.552Z|,'t',1.5],
            [|2025-11-26T10:10:58.658Z|,'s',1.6],
            [|2025-11-26T10:10:58.764Z|,'s',1.7],
            [|2025-11-26T10:10:58.854Z|,'s',1.8],
            [|2025-11-26T10:10:58.960Z|,'s',1.9],
            [|2025-11-26T10:10:59.065Z|,'t',2],
            [|2025-11-26T10:10:59.065Z|,'s',2],
            [|2025-11-26T10:10:59.155Z|,'s',2.1],
            [|2025-11-26T10:10:59.261Z|,'s',2.2],
            [|2025-11-26T10:10:59.351Z|,'s',2.3],
            [|2025-11-26T10:10:59.456Z|,'s',2.4],
            [|2025-11-26T10:10:59.562Z|,'t',2.5],
            [|2025-11-26T10:10:59.562Z|,'s',2.5],
            [|2025-11-26T10:10:59.653Z|,'s',2.6],
            [|2025-11-26T10:10:59.759Z|,'s',2.7],
            [|2025-11-26T10:10:59.864Z|,'s',2.8],
            [|2025-11-26T10:10:59.955Z|,'s',2.9],
            [|2025-11-26T10:11:00.060Z|,'t',3],
            [|2025-11-26T10:11:00.061Z|,'s',3],
            [|2025-11-26T10:11:00.151Z|,'s',3.1],
            [|2025-11-26T10:11:00.256Z|,'s',3.2],
            [|2025-11-26T10:11:00.362Z|,'s',3.3],
            [|2025-11-26T10:11:00.453Z|,'s',3.4],
            [|2025-11-26T10:11:00.558Z|,'t',3.5],
            [|2025-11-26T10:11:00.558Z|,'s',3.5],
            [|2025-11-26T10:11:00.664Z|,'s',3.6],
            [|2025-11-26T10:11:00.755Z|,'s',3.7],
            [|2025-11-26T10:11:00.861Z|,'s',3.8],
            [|2025-11-26T10:11:00.966Z|,'s',3.9],
            [|2025-11-26T10:11:01.057Z|,'t',4],
            [|2025-11-26T10:11:01.057Z|,'s',4],
            [|2025-11-26T10:11:01.162Z|,'s',4.1],
            [|2025-11-26T10:11:01.252Z|,'s',4.2],
            [|2025-11-26T10:11:01.359Z|,'s',4.3],
            [|2025-11-26T10:11:01.465Z|,'s',4.4],
            [|2025-11-26T10:11:01.555Z|,'t',4.5],
            [|2025-11-26T10:11:01.555Z|,'s',4.5],
            [|2025-11-26T10:11:01.661Z|,'s',4.6],
            [|2025-11-26T10:11:01.752Z|,'s',4.7],
            [|2025-11-26T10:11:01.858Z|,'s',4.8],
            [|2025-11-26T10:11:01.965Z|,'s',4.9],
            [|2025-11-26T10:11:02.054Z|,'t',5],
            [|2025-11-26T10:11:02.054Z|,'s',5],
            [|2025-11-26T10:11:02.160Z|,'s',5.1],
            [|2025-11-26T10:11:02.266Z|,'s',5.2],
            [|2025-11-26T10:11:02.357Z|,'s',5.29999],
            [|2025-11-26T10:11:02.462Z|,'s',5.39999],
            [|2025-11-26T10:11:02.553Z|,'s',5.49999],
            [|2025-11-26T10:11:02.553Z|,'t',5.5],
            [|2025-11-26T10:11:02.658Z|,'s',5.59999]]);


create function test_window() -> Timeval
  as ts(|2025-11-26T08:41:51.226Z|, [[|2025-11-26T08:41:49.231Z|,'t',10],
                                [|2025-11-26T08:41:49.231Z|,'s',9.99999],
                                [|2025-11-26T08:41:49.337Z|,'s',10.09999],
                                [|2025-11-26T08:41:49.428Z|,'s',10.19999],
                                [|2025-11-26T08:41:49.535Z|,'s',10.29999],
                                [|2025-11-26T08:41:49.626Z|,'s',10.39999],
                                [|2025-11-26T08:41:49.733Z|,'t',10.5],
                                [|2025-11-26T08:41:49.733Z|,'s',10.49999],
                                [|2025-11-26T08:41:49.839Z|,'s',10.59999],
                                [|2025-11-26T08:41:49.929Z|,'s',10.69999],
                                [|2025-11-26T08:41:50.036Z|,'s',10.79999],
                                [|2025-11-26T08:41:50.126Z|,'s',10.89999],
                                [|2025-11-26T08:41:50.234Z|,'t',11],
                                [|2025-11-26T08:41:50.234Z|,'s',10.99999],
                                [|2025-11-26T08:41:50.340Z|,'s',11.09999],
                                [|2025-11-26T08:41:50.430Z|,'s',11.19999],
                                [|2025-11-26T08:41:50.535Z|,'s',11.29999],
                                [|2025-11-26T08:41:50.626Z|,'s',11.39999],
                                [|2025-11-26T08:41:50.731Z|,'t',11.5],
                                [|2025-11-26T08:41:50.731Z|,'s',11.49999],
                                [|2025-11-26T08:41:50.837Z|,'s',11.59999],
                                [|2025-11-26T08:41:50.929Z|,'s',11.69999],
                                [|2025-11-26T08:41:51.036Z|,'s',11.79999],
                                [|2025-11-26T08:41:51.126Z|,'s',11.89999]]);


set :my_vectors = [["a",1.0],
                   ["b",3.0],
                   ["a",2.0],
                   ["b",1.5],
                   ["a",1.0],
                   ["b",2.8],
                   ["a",1.1],
                   ["b",4.9]];

create function compute_aggr(vector of vector window) -> vector
  as select vector of topic, sum(value)
       from Charstring topic, Real value, Vector v
      where v in window
        and [topic, value] = v
      group by topic;

// This works fine! :)
compute_aggr(:my_vectors);

set :vals = [1,2,3,4,5,6];

set :aggr_f = #'BAG.MEAN->REAL';

apply(:aggr_f,[:vals]);

call(:aggr_f,in(:vals));



// Compile error
create function compute_aggr(vector of vector window, function aggr_f) -> vector
  as select vector of topic, call(aggr_f, bag(value))
       from Charstring topic, Real value, Vector v
      where v in window
        and [topic, value] = v
      group by topic;

create function compute_aggr(vector of vector window, function aggr_f) -> vector
  as select vector of topic, call(#'BAG.MEAN->REAL', bag(value))
       from Charstring topic, Real value, Vector v
      where v in window
        and [topic, value] = v
      group by topic;




create function compute_aggr(timeval of vector of vector window,
                             function aggr_f) -> vector
/* Compute the aggregations for each topic in a bus stream window */
  as select vector of topic, reduce(value, aggr_f)
       from Real time, Charstring topic, 
            Real value, Vector v, real aggr_val
      where v in value(window)
        and [time, topic, value] = v
        //and aggr_val = apply(aggr_f,[bag(value)])[1]
      group by topic;

compute_aggr(test_window(), #'BAG.MEAN->REAL');

apply(#'VECTOR.MEAN->REAL',[[10]]);


validate "timeval_stream"
  check in(first_n(timeval_stream(test_stream()), 4))
        => bag(ts(|2025-11-26T10:10:57.052Z|, [|2025-11-26T10:10:57.052Z|,'s',0]),
                ts(|2025-11-26T10:10:57.052Z|, [|2025-11-26T10:10:57.052Z|,'t',0]),
                ts(|2025-11-26T10:10:57.165Z|, [|2025-11-26T10:10:57.165Z|,'s',0.1]),
                ts(|2025-11-26T10:10:57.255Z|, [|2025-11-26T10:10:57.255Z|,'s',0.2]));

validate "windowed_bus_stream"
  check in(first_n(windowed_bus_stream(test_stream(), 0.3), 3))
        => bag( ts(|2025-11-26T10:10:57.352Z|, [[|2025-11-26T10:10:57.052Z|,'s',0],
                                                [|2025-11-26T10:10:57.052Z|,'t',0],
                                                [|2025-11-26T10:10:57.165Z|,'s',0.1],
                                                [|2025-11-26T10:10:57.255Z|,'s',0.2]]),
                ts(|2025-11-26T10:10:57.652Z|, [[|2025-11-26T10:10:57.361Z|,'s',0.3],
                                                [|2025-11-26T10:10:57.452Z|,'s',0.4],
                                                [|2025-11-26T10:10:57.558Z|,'t',0.5],
                                                [|2025-11-26T10:10:57.558Z|,'s',0.5]]),
                ts(|2025-11-26T10:10:57.952Z|, [[|2025-11-26T10:10:57.664Z|,'s',0.6],
                                                [|2025-11-26T10:10:57.755Z|,'s',0.7],
                                                [|2025-11-26T10:10:57.860Z|,'s',0.8]]));

validate "compute_mean"
  check roundto(compute_mean(test_window()),4)
     => roundto([['s',10.94999],['t',10.75]],4);

validate "window_stats"
  check window_stats(test_window())
     => ts(|2025-11-26T08:41:51.226Z|, [['s',10.94999],['t',10.75]]);

validate "topic_means"
  check in(topic_means(test_stream(), 2))
     => bag(ts(|2025-11-26T10:10:59.052Z|, [['s',0.9500000000000002],['t',0.75]]),
            ts(|2025-11-26T10:11:01.052Z|, [['s',2.949999999999999],['t',2.75]]),
            ts(|2025-11-26T10:11:03.052Z|, [['s',4.799997647058822],['t',4.75]]));
